{% extends "base.html" %}
{% load static %}
{% block head_title %}Shopping Cart - Const Collection{% endblock %}

{% block content %}
<section class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="{% url 'index' %}">Home</a></li>
            <li>Shopping Cart</li>
        </ul>
    </div>

    <h1 class="text-4xl font-bold mb-8">Shopping Cart</h1>

    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2 space-y-4">
            {% for item in cart_items %}
            <div class="card bg-base-200 shadow-xl" data-cart-item-id="{{ item.id }}">
                <div class="card-body">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <!-- Item Image -->
                        <div class="flex-shrink-0">
                            {% if item.product_object.cover_image %}
                            <img src="{{ item.product_object.cover_image.url }}" alt="{{ item.product_title }}" class="w-24 h-24 object-cover rounded-lg">
                            {% elif item.product_object.images.first %}
                            <img src="{{ item.product_object.images.first.image.url }}" alt="{{ item.product_object.images.first.alt_text }}" class="w-24 h-24 object-cover rounded-lg">
                            {% else %}
                            <div class="w-24 h-24 bg-base-300 rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Item Details -->
                        <div class="flex-grow">
                            <h3 class="card-title text-lg">{{ item.product_title }}</h3>
                            {% if item.product_sku %}
                            <p class="text-sm text-base-content/70">SKU: {{ item.product_sku }}</p>
                            {% endif %}
                            <p class="text-lg font-semibold text-primary">€{{ item.unit_price }}</p>
                        </div>

                        <!-- Quantity and Actions -->
                        <div class="flex flex-col items-end gap-2">
                            <!-- Quantity Controls -->
                            <div class="flex items-center gap-2" data-item-id="{{ item.id }}" data-current-quantity="{{ item.quantity }}">
                                <button class="btn btn-sm btn-circle btn-outline decrease-qty"
                                        {% if item.quantity <= 1 %}disabled{% endif %}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                    </svg>
                                </button>
                                <span class="px-3 py-1 bg-base-100 rounded quantity-display">{{ item.quantity }}</span>
                                <button class="btn btn-sm btn-circle btn-outline increase-qty">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>

                            <!-- Subtotal -->
                            <p class="text-sm font-semibold">€{{ item.total_price }}</p>

                            <!-- Remove Button -->
                            <button class="btn btn-sm btn-ghost text-error remove-item" data-item-id="{{ item.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Cart Summary -->
        <div class="lg:col-span-1">
            <div class="card bg-base-200 shadow-xl sticky top-4">
                <div class="card-body">
                    <h3 class="card-title">Order Summary</h3>

                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Items ({{ total_items }})</span>
                            <span>€{{ total_price }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping</span>
                            <span>Calculated at checkout</span>
                        </div>
                        <div class="divider"></div>
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total</span>
                            <span>€{{ total_price }}</span>
                        </div>
                    </div>

                    <div class="card-actions justify-end mt-6">
                        <a href="{% url 'orders:checkout' %}" class="btn btn-primary btn-block">
                            Proceed to Checkout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty Cart -->
    <div class="text-center py-16">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-base-content/30 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h2 class="text-2xl font-bold mb-4">Your cart is empty</h2>
        <p class="text-base-content/70 mb-8">Add some beautiful artwork to get started!</p>
        <a href="{% url 'gallery:collection' %}" class="btn btn-primary">
            Browse Gallery
        </a>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_body %}
<script>
// Initialize event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for quantity controls
    document.querySelectorAll('.decrease-qty').forEach(button => {
        button.addEventListener('click', function() {
            const container = this.closest('[data-item-id]');
            const itemId = parseInt(container.getAttribute('data-item-id'));
            const currentQty = parseInt(container.getAttribute('data-current-quantity'));
            updateQuantity(itemId, currentQty - 1);
        });
    });

    document.querySelectorAll('.increase-qty').forEach(button => {
        button.addEventListener('click', function() {
            const container = this.closest('[data-item-id]');
            const itemId = parseInt(container.getAttribute('data-item-id'));
            const currentQty = parseInt(container.getAttribute('data-current-quantity'));
            updateQuantity(itemId, currentQty + 1);
        });
    });

    // Add event listeners for remove buttons
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = parseInt(this.getAttribute('data-item-id'));
            removeItem(itemId);
        });
    });
});

async function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;

    try {
        const response = await fetch(`/orders/cart/item/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                quantity: newQuantity
            })
        });

        if (response.ok) {
            // Update quantity display and data attribute
            const container = document.querySelector(`[data-item-id="${itemId}"]`);
            if (container) {
                container.setAttribute('data-current-quantity', newQuantity);
                const quantityDisplay = container.querySelector('.quantity-display');
                if (quantityDisplay) {
                    quantityDisplay.textContent = newQuantity;
                }
                // Update decrease button state
                const decreaseBtn = container.querySelector('.decrease-qty');
                if (decreaseBtn) {
                    decreaseBtn.disabled = newQuantity <= 1;
                }
            }
            // Update totals by reloading the page for now
            setTimeout(() => window.location.reload(), 500);
        } else {
            const errorData = await response.json();
            alert('Error updating quantity: ' + (errorData.detail || 'Please try again.'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating quantity. Please try again.');
    }
}

async function removeItem(itemId) {
    if (!confirm('Remove this item from your cart?')) return;

    try {
        const response = await fetch(`/orders/cart/item/${itemId}/remove/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });

        if (response.ok) {
            // Reload the page to show updated cart
            window.location.reload();
        } else {
            const errorData = await response.json();
            alert('Error removing item: ' + (errorData.detail || 'Please try again.'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error removing item. Please try again.');
    }
}

function getCsrfToken() {
    // Try multiple ways to get the CSRF token
    const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (tokenInput) {
        return tokenInput.value;
    }

    // Fallback: check meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }

    // Last resort: check cookies
    const cookieName = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(cookieName + '=')) {
            return cookie.substring(cookieName.length + 1);
        }
    }

    return '';
}
</script>
{% endblock %}